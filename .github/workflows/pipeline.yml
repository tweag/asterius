name: pipeline

on:
  - push
  - pull_request

jobs:

  docs:
    name: docs
    runs-on: ubuntu-latest
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
    steps:

      - name: setup-deps
        run: |
          pip install \
            recommonmark \
            sphinx

      - name: checkout
        uses: actions/checkout@v2

      - name: docs
        run: |
          cd docs
          sphinx-build . _build

          cp tweag-logo.svg _build

          mkdir _build/demo
          pushd _build/demo

          mkdir diagrams
          pushd diagrams
          curl -L https://asterius.s3-us-west-2.amazonaws.com/diagrams.tar | tar x
          popd

          mkdir pandoc
          pushd pandoc
          curl -L https://asterius.s3-us-west-2.amazonaws.com/pandoc.tar | tar x
          popd

          mkdir ormolu
          pushd ormolu
          curl -L https://asterius.s3-us-west-2.amazonaws.com/ormolu.tar | tar x
          popd

          mkdir todomvc
          pushd todomvc
          curl -L https://asterius.s3-us-west-2.amazonaws.com/todomvc.tar | tar x
          popd

          popd

          if [ $GITHUB_REPOSITORY = "tweag/asterius" ]
          then
            if [ $(git rev-parse --abbrev-ref HEAD) = "master" ]
            then
              netlify deploy --dir=_build --message="$GITHUB_REF-$GITHUB_SHA" --prod
            else
              netlify deploy --dir=_build --message="$GITHUB_REF-$GITHUB_SHA"
            fi
          fi
